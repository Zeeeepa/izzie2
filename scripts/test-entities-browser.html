<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Entities API</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #007bff;
    }
    .stat-label {
      font-size: 0.9em;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #007bff;
    }
    .entities-list {
      margin-top: 20px;
    }
    .entity-item {
      background: #f8f9fa;
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 3px solid #28a745;
    }
    .entity-type {
      display: inline-block;
      background: #007bff;
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 0.8em;
      margin-right: 10px;
    }
    .entity-value {
      font-weight: 500;
    }
    .entity-meta {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .code-block {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 10px 0;
    }
    pre {
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Entities API Test</h1>
    <p>Testing <code>/api/entities</code> endpoint in single-user mode</p>

    <button id="testBtn" onclick="testAPI()">Test API</button>

    <div id="status"></div>
    <div id="stats"></div>
    <div id="entities"></div>
    <div id="rawResponse"></div>
  </div>

  <script>
    async function testAPI() {
      const statusEl = document.getElementById('status');
      const statsEl = document.getElementById('stats');
      const entitiesEl = document.getElementById('entities');
      const rawResponseEl = document.getElementById('rawResponse');
      const testBtn = document.getElementById('testBtn');

      // Reset
      statusEl.className = 'status loading';
      statusEl.innerHTML = 'üîÑ Testing API endpoint...';
      statsEl.innerHTML = '';
      entitiesEl.innerHTML = '';
      rawResponseEl.innerHTML = '';
      testBtn.disabled = true;

      try {
        const response = await fetch('/api/entities?limit=20');
        const data = await response.json();

        if (response.ok) {
          statusEl.className = 'status success';
          statusEl.innerHTML = `‚úÖ <strong>SUCCESS!</strong> API returned ${data.total} entities`;

          // Display stats
          if (data.stats) {
            let statsHTML = '<div class="stats">';
            for (const [type, count] of Object.entries(data.stats)) {
              statsHTML += `
                <div class="stat-card">
                  <div class="stat-label">${type}</div>
                  <div class="stat-value">${count}</div>
                </div>
              `;
            }
            statsHTML += '</div>';
            statsEl.innerHTML = statsHTML;
          }

          // Display entities
          if (data.entities && data.entities.length > 0) {
            let entitiesHTML = '<h3>Sample Entities:</h3><div class="entities-list">';
            data.entities.slice(0, 10).forEach(entity => {
              entitiesHTML += `
                <div class="entity-item">
                  <span class="entity-type">${entity.type}</span>
                  <span class="entity-value">${entity.value}</span>
                  <div class="entity-meta">
                    Confidence: ${(entity.confidence * 100).toFixed(0)}% |
                    Source: ${entity.source} |
                    ${entity.context ? `Context: ${entity.context.substring(0, 100)}...` : ''}
                  </div>
                </div>
              `;
            });
            entitiesHTML += '</div>';
            entitiesEl.innerHTML = entitiesHTML;
          }

          // Display raw response
          rawResponseEl.innerHTML = `
            <h3>Raw API Response:</h3>
            <div class="code-block">
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;

        } else {
          statusEl.className = 'status error';
          statusEl.innerHTML = `
            ‚ùå <strong>ERROR:</strong> ${data.error || 'Unknown error'}<br>
            ${data.details ? `Details: ${data.details}` : ''}
          `;

          if (response.status === 401) {
            statusEl.innerHTML += '<br><br>üí° <strong>Note:</strong> You need to be logged in to access this API.';
          }

          rawResponseEl.innerHTML = `
            <h3>Error Response:</h3>
            <div class="code-block">
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </div>
          `;
        }
      } catch (error) {
        statusEl.className = 'status error';
        statusEl.innerHTML = `‚ùå <strong>FETCH ERROR:</strong> ${error.message}`;
      } finally {
        testBtn.disabled = false;
      }
    }

    // Auto-run on load
    window.addEventListener('load', testAPI);
  </script>
</body>
</html>
